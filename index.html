<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Room Temperature Status</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Map is hidden by default; shown only when temperature > setpoint */
    #map { height: 560px; width: 100%; display: none; }
    .leaflet-popup-content-wrapper { border-radius: 12px; background: #fffaf5; }
  </style>
</head>
<body>
  <h1>üå°Ô∏è Room Temperature</h1>
  
  <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
    <label for="setpoint">Temperature Setpoint (¬∞C):</label>
    <input type="number" id="setpoint" placeholder="Enter desired temperature" step="0.1" style="padding: 5px; margin-left: 10px; width: 150px;">
    <button onclick="setTemperatureSetpoint()" style="padding: 5px 15px; margin-left: 10px; cursor: pointer;">Set</button>
  </div>

  <p id="temp">Loading...</p>
  <p id="warning" style="color: red; font-weight: bold; display: none; margin-top: 10px;">‚ö†Ô∏è WARNING: Current temperature is HIGHER than setpoint!</p>

  <script>
    let temperatureSetpoint = localStorage.getItem('temperatureSetpoint') || 25;

    function setTemperatureSetpoint() {
      const input = document.getElementById('setpoint').value;
      if (input === '') {
        alert('Please enter a temperature setpoint');
        return;
      }
      temperatureSetpoint = parseFloat(input);
      localStorage.setItem('temperatureSetpoint', temperatureSetpoint);
      document.getElementById('setpoint').value = '';
      alert(`Temperature setpoint set to ${temperatureSetpoint}¬∞C`);
    }

    function fetchTemperature() {
      fetch("https://temperature-server.onrender.com/temperature")
        .then(res => res.json())
        .then(data => {
          const currentTemp = data.temperature;
          document.getElementById('temp').innerText =
            `Current temperature: ${currentTemp} ¬∞C | Setpoint: ${temperatureSetpoint}¬∞C`;
          
          // Check if current temperature is greater than setpoint
          const warningElement = document.getElementById('warning');
          const isAbove = parseFloat(currentTemp) > parseFloat(temperatureSetpoint);
          if (isAbove) {
            warningElement.style.display = 'block';
            // Show map and update Toronto marker
            showMapIfNeeded();
            updateTorontoMarker(true);
            // Send alert to backend
            sendTemperatureAlert(currentTemp, temperatureSetpoint);
          } else {
            warningElement.style.display = 'none';
            updateTorontoMarker(false);
            hideMap();
          }
        })
        .catch(err => {
          document.getElementById('temp').innerText = "Error fetching data.";
        });
    }

    function sendTemperatureAlert(currentTemp, setpoint) {
      fetch("https://temperature-server.onrender.com/temperature/alert", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          current_temperature: currentTemp,
          threshold_temperature: setpoint
        })
      })
        .then(res => res.json())
        .then(data => {
          console.log("Alert response:", data);
        })
        .catch(err => {
          console.error("Error sending alert:", err);
        });
    }

    // Fetch immediately on page load
    fetchTemperature();

    // Auto-refresh every 5 seconds
    setInterval(fetchTemperature, 5000);

    // Display the stored setpoint on page load and initialize map
    window.onload = function() {
      document.getElementById('setpoint').placeholder = `Current setpoint: ${temperatureSetpoint}¬∞C`;
      if (typeof initMap === 'function') initMap();
    };
  </script>

  <!-- Inlined Canada map -->
  <section style="margin-top: 30px;">
    <h2>üó∫Ô∏è Canada Map (Toronto alert)</h2>
    <p style="margin-top:0; margin-bottom:8px; color:#555;">Map displays only when current temperature exceeds the setpoint.</p>
    <div style="border:1px solid #ddd; border-radius:6px; overflow:hidden;">
      <div id="map"></div>
    </div>
    <p style="font-size:90%; color:#666; margin-top:8px;">If the map does not load, <a href="../Mapping/canada_map.html" target="_blank" rel="noopener">open it in a new tab</a>.</p>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map and Toronto marker; called on window.onload
    let torontoMarker = null;
    function initMap() {
      const map = L.map('map', { zoomControl: false }).setView([56, -96], 4);
      // store global reference for later marker operations
      window.__leafletMap = map;

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      }).addTo(map);

        // Toronto marker will be created lazily when needed
        torontoMarker = null;
    }

    // Helper to update Toronto marker: blink yellow for 1s when `isAbove` true
    function updateTorontoMarker(isAbove) {
      // If below threshold, remove marker from map (if present)
      if (!isAbove) {
        if (torontoMarker && torontoMarker.remove) {
          torontoMarker.remove();
          torontoMarker = null;
        }
        return;
      }

      // Above threshold: ensure map and marker exist
      showMapIfNeeded();
      if (!torontoMarker) {
        torontoMarker = L.circleMarker([43.6532, -79.3832], {
          radius: 12,
          fillColor: '#ffd43b', // start yellow for blink
          color: '#ffffff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.9
        }).addTo(window.__leafletMap).bindPopup('<strong>Toronto</strong>');
      }

      // Blink: toggle visibility every 200ms for 1 second, then set to red
      let blinkCount = 0;
      const maxBlinks = 5; // 5 toggles == ~1s (200ms each)
      const originalFill = '#e63946';
      const blinkColor = '#ffd43b';

      const blinkInterval = setInterval(() => {
        if (!torontoMarker) {
          clearInterval(blinkInterval);
          return;
        }
        const visible = (blinkCount % 2) === 0;
        torontoMarker.setStyle({ fillColor: visible ? blinkColor : '#ffffff', fillOpacity: visible ? 0.9 : 0.0 });
        blinkCount += 1;
        if (blinkCount >= maxBlinks) {
          clearInterval(blinkInterval);
          // Final state: solid red and open popup
          if (torontoMarker) {
            torontoMarker.setStyle({ fillColor: originalFill, fillOpacity: 0.9 });
            torontoMarker.openPopup();
          }
        }
      }, 200);
    }

    // Show/hide map container (initialize map on first show)
    let mapInitialized = false;
    function showMapIfNeeded() {
      const mapEl = document.getElementById('map');
      if (!mapEl) return;
      if (!mapInitialized) {
        mapEl.style.display = 'block';
        initMap();
        mapInitialized = true;
      } else {
        mapEl.style.display = 'block';
      }
    }

    function hideMap() {
      const mapEl = document.getElementById('map');
      if (mapEl) mapEl.style.display = 'none';
      // Also remove marker if present
      if (torontoMarker && torontoMarker.remove) {
        torontoMarker.remove();
        torontoMarker = null;
      }
    }

    // Keep a global reference to the Leaflet map for marker creation
    // assigned in initMap
  </script>
</body>
</html>
