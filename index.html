<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Room Temperature Status</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 560px; width: 100%; }
    .quake-dot { filter: drop-shadow(0 0 6px rgba(255, 90, 90, 0.9)); }
    .leaflet-popup-content-wrapper { border-radius: 12px; background: #fffaf5; }
  </style>
</head>
<body>
  <h1>üå°Ô∏è Room Temperature</h1>
  
  <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
    <label for="setpoint">Temperature Setpoint (¬∞C):</label>
    <input type="number" id="setpoint" placeholder="Enter desired temperature" step="0.1" style="padding: 5px; margin-left: 10px; width: 150px;">
    <button onclick="setTemperatureSetpoint()" style="padding: 5px 15px; margin-left: 10px; cursor: pointer;">Set</button>
  </div>

  <p id="temp">Loading...</p>
  <p id="warning" style="color: red; font-weight: bold; display: none; margin-top: 10px;">‚ö†Ô∏è WARNING: Current temperature is HIGHER than setpoint!</p>

  <script>
    let temperatureSetpoint = localStorage.getItem('temperatureSetpoint') || 25;

    function setTemperatureSetpoint() {
      const input = document.getElementById('setpoint').value;
      if (input === '') {
        alert('Please enter a temperature setpoint');
        return;
      }
      temperatureSetpoint = parseFloat(input);
      localStorage.setItem('temperatureSetpoint', temperatureSetpoint);
      document.getElementById('setpoint').value = '';
      alert(`Temperature setpoint set to ${temperatureSetpoint}¬∞C`);
    }

    function fetchTemperature() {
      fetch("https://temperature-server.onrender.com/temperature")
        .then(res => res.json())
        .then(data => {
          const currentTemp = data.temperature;
          document.getElementById('temp').innerText =
            `Current temperature: ${currentTemp} ¬∞C | Setpoint: ${temperatureSetpoint}¬∞C`;
          
          // Check if current temperature is greater than setpoint
          const warningElement = document.getElementById('warning');
          if (currentTemp > temperatureSetpoint) {
            warningElement.style.display = 'block';
            // Send alert to backend
            sendTemperatureAlert(currentTemp, temperatureSetpoint);
          } else {
            warningElement.style.display = 'none';
          }
        })
        .catch(err => {
          document.getElementById('temp').innerText = "Error fetching data.";
        });
    }

    function sendTemperatureAlert(currentTemp, setpoint) {
      fetch("https://temperature-server.onrender.com/temperature/alert", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          current_temperature: currentTemp,
          threshold_temperature: setpoint
        })
      })
        .then(res => res.json())
        .then(data => {
          console.log("Alert response:", data);
        })
        .catch(err => {
          console.error("Error sending alert:", err);
        });
    }

    // Fetch immediately on page load
    fetchTemperature();

    // Auto-refresh every 5 seconds
    setInterval(fetchTemperature, 5000);

    // Display the stored setpoint on page load and initialize map
    window.onload = function() {
      document.getElementById('setpoint').placeholder = `Current setpoint: ${temperatureSetpoint}¬∞C`;
      if (typeof initMap === 'function') initMap();
    };
  </script>

  <!-- Inlined Canada map -->
  <section style="margin-top: 30px;">
    <h2>üó∫Ô∏è Canada Map (Earthquakes)</h2>
    <p style="margin-top:0; margin-bottom:8px; color:#555;">Interactive map embedded below. If the map does not load, open in a new tab.</p>
    <div style="border:1px solid #ddd; border-radius:6px; overflow:hidden;">
      <div id="map"></div>
    </div>
    <p style="font-size:90%; color:#666; margin-top:8px;">If the map does not load, <a href="../Mapping/canada_map.html" target="_blank" rel="noopener">open it in a new tab</a>.</p>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map and Toronto marker; called on window.onload
    let torontoMarker = null;
    function initMap() {
      const map = L.map('map', { zoomControl: false }).setView([56, -96], 4);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      }).addTo(map);

      // Toronto marker (will change color when temp > setpoint)
      torontoMarker = L.circleMarker([43.6532, -79.3832], {
        radius: 12,
        fillColor: '#2b8cbe',
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.9
      }).addTo(map).bindPopup('<strong>Toronto</strong>');

      // Earthquake dots (kept from canada_map.html)
      fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson')
        .then(res => res.json())
        .then(data => {
          data.features.forEach(eq => {
            const [lng, lat] = eq.geometry.coordinates;
            const mag = eq.properties.mag || 0;
            if (mag < 1) return;
            let color = '#ffb703';
            if (mag >= 4) color = '#fb8500';
            if (mag >= 6) color = '#e63946';
            const dot = L.circleMarker([lat, lng], {
              radius: mag * 3 + 4,
              fillColor: color,
              color: '#ffffff',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.9,
              className: 'quake-dot'
            });
            dot.bindPopup(`\n              <strong>üåã Earthquake</strong><br/>\n              Magnitude: ${mag}<br/>\n              ${eq.properties.place}\n            `);
            dot.addTo(map);
          });
        });
    }

    // Helper to update Toronto marker color based on setpoint/comparison
    function updateTorontoMarker(isAbove) {
      if (!torontoMarker) return;
      torontoMarker.setStyle({ fillColor: isAbove ? '#e63946' : '#2b8cbe' });
      if (isAbove) {
        torontoMarker.openPopup();
      } else {
        torontoMarker.closePopup();
      }
    }
  </script>
</body>
</html>
